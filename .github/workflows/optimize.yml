name: Optimize Subtitles

on:
  push:
    paths:
      - 'talks/*/*/work/uk_corrected.srt'
  workflow_dispatch:
    inputs:
      talk_id:
        description: 'Talk directory name (e.g., 1983-07-24_guru-puja)'
        required: true
        type: string
      video_slug:
        description: 'Video subdirectory (e.g., Talk). Leave empty for all videos.'
        required: false
        type: string

permissions:
  contents: write

jobs:
  optimize:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-optimize-${{ hashFiles('requirements.txt') }}
          restore-keys: pip-optimize-

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Detect changed files
        id: detect
        run: |
          if [ -n "${{ inputs.talk_id }}" ] && [ -n "${{ inputs.video_slug }}" ]; then
            # Manual trigger: specific video
            echo "talks/${{ inputs.talk_id }}/${{ inputs.video_slug }}/work/uk_corrected.srt" > /tmp/changed_srts.txt
          elif [ -n "${{ inputs.talk_id }}" ]; then
            # Manual trigger: all videos in talk
            find "talks/${{ inputs.talk_id }}" -path '*/work/uk_corrected.srt' > /tmp/changed_srts.txt
          else
            # Push trigger: detect ALL changed uk_corrected.srt files
            git diff --name-only HEAD~1 HEAD | grep 'talks/.*/work/uk_corrected.srt' > /tmp/changed_srts.txt || true
          fi
          echo "Files to optimize:"
          cat /tmp/changed_srts.txt

      - name: Run optimizer for each changed file
        run: |
          while IFS= read -r srt_path; do
            [ -z "$srt_path" ] && continue
            [ -f "$srt_path" ] || { echo "SKIP (not found): $srt_path"; continue; }

            # Extract talk_id and video_slug from path: talks/{talk_id}/{video_slug}/work/...
            talk_id=$(echo "$srt_path" | cut -d'/' -f2)
            video_slug=$(echo "$srt_path" | cut -d'/' -f3)

            echo "=== Optimizing: $talk_id / $video_slug ==="
            final_dir="talks/$talk_id/$video_slug/final"
            mkdir -p "$final_dir"

            # Build optimizer arguments (--json is optional)
            json_path="talks/$talk_id/$video_slug/source/whisper.json"
            json_arg=""
            if [ -f "$json_path" ]; then
              json_arg="--json $json_path"
            else
              echo "  Note: whisper.json not found, running without it"
            fi

            python -m tools.optimize_srt \
              --srt "$srt_path" \
              $json_arg \
              --output "$final_dir/uk.srt" \
              --report "$final_dir/report.txt"
          done < /tmp/changed_srts.txt

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add talks/*/*/final/uk.srt talks/*/*/final/report.txt
          git diff --cached --quiet && { echo "No changes to commit"; exit 0; }
          git commit -m "Optimize subtitles"
          git pull --rebase
          git push
