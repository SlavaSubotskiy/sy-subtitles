name: Whisper Speech Detection

on:
  workflow_dispatch:
    inputs:
      talk_id:
        description: 'Talk directory name (e.g., 1983-07-24_guru-puja). Leave empty to auto-discover all pending.'
        required: false
        type: string
  workflow_call:
    inputs:
      talk_id:
        description: 'Talk directory name'
        required: true
        type: string

permissions:
  contents: write

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}
      has_jobs: ${{ steps.build.outputs.has_jobs }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install pyyaml

      - name: Build video matrix
        id: build
        run: |
          python3 << 'PYEOF'
          import json
          import os
          import yaml

          talk_id_input = "${{ inputs.talk_id }}".strip()

          # Find meta.yaml files
          if talk_id_input:
              meta_paths = [f"talks/{talk_id_input}/meta.yaml"]
          else:
              meta_paths = sorted(
                  f"talks/{d}/meta.yaml"
                  for d in os.listdir("talks")
                  if os.path.isfile(f"talks/{d}/meta.yaml")
              )

          matrix = []
          for meta_path in meta_paths:
              if not os.path.isfile(meta_path):
                  print(f"WARNING: {meta_path} not found, skipping")
                  continue

              talk_id = meta_path.split("/")[1]
              with open(meta_path) as f:
                  meta = yaml.safe_load(f)

              videos = meta.get("videos", [])
              for video in videos:
                  slug = video["slug"]
                  vimeo_url = video["vimeo_url"]
                  whisper_path = f"talks/{talk_id}/{slug}/source/whisper.json"

                  if os.path.isfile(whisper_path):
                      print(f"SKIP: {whisper_path} already exists")
                      continue

                  matrix.append({
                      "talk_id": talk_id,
                      "video_slug": slug,
                      "vimeo_url": vimeo_url,
                  })
                  print(f"QUEUE: {talk_id}/{slug}")

          has_jobs = "true" if matrix else "false"
          print(f"\nTotal jobs: {len(matrix)}")

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"matrix={json.dumps({'include': matrix})}\n")
              f.write(f"has_jobs={has_jobs}\n")
          PYEOF

  whisper:
    needs: discover
    if: needs.discover.outputs.has_jobs == 'true'
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 3
      fail-fast: false
      matrix: ${{ fromJson(needs.discover.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: pip-whisper-${{ hashFiles('requirements.txt') }}
          restore-keys: pip-whisper-

      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y ffmpeg

      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
          pip install openai-whisper

      - name: Cache Whisper model
        uses: actions/cache@v4
        with:
          path: ~/.cache/whisper
          key: whisper-medium

      - name: Download video (temporary)
        run: |
          mkdir -p /tmp/whisper_work
          yt-dlp \
            --referer "https://www.amruta.org/" \
            -o "/tmp/whisper_work/video.mp4" \
            "${{ matrix.vimeo_url }}"

      - name: Run Whisper
        run: |
          mkdir -p "talks/${{ matrix.talk_id }}/${{ matrix.video_slug }}/source"
          python -m tools.whisper_run \
            --video /tmp/whisper_work/video.mp4 \
            --output "talks/${{ matrix.talk_id }}/${{ matrix.video_slug }}/source/whisper.json" \
            --model medium \
            --language en

      - name: Cleanup video
        if: always()
        run: rm -rf /tmp/whisper_work

      - name: Upload whisper artifact
        uses: actions/upload-artifact@v4
        with:
          name: whisper__${{ matrix.talk_id }}__${{ matrix.video_slug }}
          path: talks/${{ matrix.talk_id }}/${{ matrix.video_slug }}/source/whisper.json

  commit:
    needs: [discover, whisper]
    if: needs.discover.outputs.has_jobs == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all whisper artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: whisper__*
          merge-multiple: false

      - name: Place artifacts into talk directories
        run: |
          for dir in whisper__*/; do
            [ -d "$dir" ] || continue
            name="${dir%/}"
            # Format: whisper__{talk_id}__{video_slug}
            # talk_id = everything between first __ and last __
            rest="${name#whisper__}"
            video_slug="${rest##*__}"
            talk_id="${rest%__*}"
            if [ -f "$dir/whisper.json" ]; then
              dest="talks/${talk_id}/${video_slug}/source"
              mkdir -p "$dest"
              cp "$dir/whisper.json" "$dest/whisper.json"
              echo "Placed: $dest/whisper.json"
            fi
          done

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add talks/*/*/source/whisper.json
          git diff --cached --quiet && { echo "No changes to commit"; exit 0; }
          git commit -m "Add Whisper data"
          git pull --rebase
          git push
