name: Download Materials

on:
  workflow_dispatch:
    inputs:
      amruta_url:
        description: 'amruta.org talk page URL'
        required: true
        type: string
      talk_date:
        description: 'Talk date (YYYY-MM-DD)'
        required: true
        type: string
      talk_slug:
        description: 'Short talk identifier (e.g., guru-puja)'
        required: true
        type: string
      run_whisper:
        description: 'Run Whisper after download'
        required: false
        type: boolean
        default: true

jobs:
  download:
    runs-on: ubuntu-latest
    outputs:
      talk_id: ${{ steps.vars.outputs.talk_id }}
      vimeo_url: ${{ steps.download.outputs.vimeo_url }}
      run_whisper: ${{ inputs.run_whisper }}
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Set variables
        id: vars
        run: echo "talk_id=${{ inputs.talk_date }}_${{ inputs.talk_slug }}" >> "$GITHUB_OUTPUT"

      - name: Download materials
        id: download
        env:
          AMRUTA_SESSION_COOKIE: ${{ secrets.AMRUTA_SESSION_COOKIE }}
        run: |
          TALK_DIR="talks/${{ steps.vars.outputs.talk_id }}/source"
          python -m tools.download \
            --url "${{ inputs.amruta_url }}" \
            --talk-dir "$TALK_DIR" \
            --what srt,text

          # Extract Vimeo URL from download output for whisper step
          VIMEO_URL=$(python -c "
          from tools.download import AmrutaDownloader
          import os
          d = AmrutaDownloader()
          soup = d.fetch_talk_page('${{ inputs.amruta_url }}')
          url = d.extract_vimeo_url(soup)
          print(url or '')
          ")
          echo "vimeo_url=$VIMEO_URL" >> "$GITHUB_OUTPUT"

      - name: Create meta.yaml
        run: |
          TALK_DIR="talks/${{ steps.vars.outputs.talk_id }}"
          cat > "$TALK_DIR/source/meta.yaml" << 'METAEOF'
          title: "${{ inputs.talk_slug }}"
          date: "${{ inputs.talk_date }}"
          amruta_url: "${{ inputs.amruta_url }}"
          vimeo_url: "${{ steps.download.outputs.vimeo_url }}"
          language: uk
          METAEOF

      - name: Generate CLAUDE.md from template
        run: |
          TALK_DIR="talks/${{ steps.vars.outputs.talk_id }}"
          TALK_ID="${{ steps.vars.outputs.talk_id }}"
          sed \
            -e "s|{{DATE}}|${{ inputs.talk_date }}|g" \
            -e "s|{{SLUG}}|${{ inputs.talk_slug }}|g" \
            -e "s|{{TALK_ID}}|$TALK_ID|g" \
            templates/CLAUDE_talk.md > "$TALK_DIR/CLAUDE.md"

      - name: Create work directory
        run: mkdir -p "talks/${{ steps.vars.outputs.talk_id }}/work"

      - name: Commit & push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "talks/${{ steps.vars.outputs.talk_id }}/"
          git commit -m "Add source materials for ${{ steps.vars.outputs.talk_id }}"
          git push

  trigger-whisper:
    needs: download
    if: ${{ inputs.run_whisper }}
    uses: ./.github/workflows/whisper.yml
    with:
      talk_id: ${{ needs.download.outputs.talk_id }}
      vimeo_url: ${{ needs.download.outputs.vimeo_url }}
    secrets: inherit
